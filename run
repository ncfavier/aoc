#!/bin/bash

time=0

while getopts :t o; do case $o in
    t) time=1;;
esac done

shift "$(( OPTIND - 1 ))"

day=${1:-$(date +%-d)}
year=${2:-$(date +%Y)}

printf -v module 'Day%02d' "$day"

input=inputs/$year/$day
mkdir -p "$(dirname "$input")"

bin=bin/$year/$day
mkdir -p "$(dirname "$bin")"

build=build/$year
mkdir -p "$build"

if [[ ! -e $input ]]; then
    echo "==> Downloading input for day $day, $year"
    curl -fsSL -o "$input" -b "session=$(< .session)" "https://adventofcode.com/$year/day/$day/input"
fi

run() {
    AOC_INPUT=$input "$bin"
}

echo "==> Compiling day $day, $year"
if ghc -O2 -dynamic -isrc -i"src/$year" -outputdir "$build" -o "$bin" -main-is "$module" "src/$year/$module.hs"; then
    echo "==> Running day $day, $year"
    if (( time )); then
        time run
    else
        run
    fi
fi
